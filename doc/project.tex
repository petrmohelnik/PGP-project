%--------------------------------------------------------------------------------
%\documentclass{article}

\documentclass[a4paper, 12pt]{article}
\usepackage[bf]{caption}
\usepackage{hyperref}
\usepackage[all]{hypcap}
\usepackage[latin2]{inputenc}
\usepackage[T1, IL2]{fontenc}
\usepackage{graphicx}
\usepackage[czech, english]{babel}
\selectlanguage{czech}
\usepackage{subfig}                % \subfloat
\usepackage{color}
\usepackage{url}
%\inputencoding{utf8}
%\usepackage[bf]{caption2}
\usepackage{hyperref}
\usepackage[all]{hypcap}
\hypersetup{colorlinks=false, linkbordercolor=1 1 1, citebordercolor=1 1 1}
\usepackage[right]{lineno}
\renewcommand\linenumberfont{\normalfont\tiny\color{blue}}


\title{Zobrazování dýmu simulovaného pomocí èásticového systému}
\author{Petr Mohelník <xmohel01@stud.fit.vutbr.cz>,\\Tomá¹ Rù¾ièka <xruzic42@stud.fit.vutbr.cz>}
\date{\today}


%--------------------------------------------------------------------------------


\begin{document}
\selectlanguage{czech}
\maketitle

\section{Úvod}

Tato práce se zamìøuje na realistickou simulaci a zobrazení dýmu pomocí grafické karty. Vyu¾ití by mìlo být v aplikacích pracujících v reálném èase, napø. hrách. V poèítaèových hrách mù¾e být dým vyu¾it u explozí, mlhy a ohnì apod.

Tady by mìlo být napsané o èem práce je a k èemu to je dobré. Napøíklad: Tato práce se zabývá akcelerací
raytracingu na CUDA. Raytracing se pou¾ívá ve fotorealistické grafice a herní grafice. CUDA umo¾òuje
akceleraci ...

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Teorie}
Pøístupy pro simulaci kapalin a plynù se dají rozdìlit do dvou kategorií. Jeden je Eulerùv pøístup, kde je prostor rozdìlen na fixní 2D nebo 3D møí¾ku. Ka¾dá buòka v møí¾ce obsahuje informace o kapalinì nebo plynu na dané nemìnné pozici. Tyto informace mohou být tlak, hustota, teplota, viskozita aj. Oproti tomu Lagrangeùv pøístup vyu¾ívá èástice s promìnlivou pozicí jako nositele informace. Oproti Eulerovu pøístupu není vázán na fixní møí¾ku a mù¾e se libovolnì rozpínat v prostoru. Na druhou stranu mù¾e být výpoèetnì nároènìj¹í kvùli nutnosti vyhledávání okolních èástic. Tyto pøístupy se nìkdy kombinují.

V tomto projektu jsme zvolily Lagrangeovu metodu \cite{Muller} zalo¾enou na Smoothed Particle Hydrodynamics (SPH), která pro simulaci vyu¾ívá èástice. Øe¹í nestlaèitelnost, symetrii sil, konzervaci hybnosti. SPH je interpolaèní metoda. Ka¾dá èástice má prostorovou vzdálenost $h$ urèující, které okolní èástice na ní mají vliv. 
V SPH se fyzikální hodnota na pozici $\mathbf{r}$ urèí jako vá¾ená suma fyzikálních hodnot $\phi_j$ sousedních èástic $j$:
\begin{equation}
  \label{basic}
  \phi(\mathbf{r}) = \sum_{j} m_j \frac{\phi_j}{\rho_j}W(\mathbf{r} - \mathbf{r}_j,h)
\end{equation}
kde $m_i$ je hmotnost èástice. Hmotnost je konstantní po celou dobu simulace a shodná pro v¹echny èástice a $W(\mathbf{r},h)$ je symetrická vyhlazovací funkce. Hustota $\rho_i$ se vypoèítá:
\begin{equation}
  \label{density}
  \rho_i = \sum_{j} m_j W(\mathbf{r}_i - \mathbf{r}_j,h)
\end{equation}
kde $\mathbf{r}_i$ je pozice èástice $i$. Akcelerace $\mathbf{a}_i$ èástice $i$ se urèí následovnì:
\begin{equation}
  \label{acceleration}
  \mathbf{a}_i = \frac{\mathbf{f}_i}{\rho_i}
\end{equation}
kde $\mathbf{f}_i$ se spoèítá jako $\mathbf{f}_i = \mathbf{f}_i^{viscosity} + \mathbf{f}_i^{pressure} + \mathbf{f}_i^{external}$.

\vspace*{1\baselineskip}

Tlaková síla $\mathbf{f}_i^{pressure}$ je ze vztahu \ref{basic} urèena:
\begin{equation}
  \label{pressure_1}
  \mathbf{f}_i^{pressure} = \sum_{j} m_j \frac{p_j}{\rho_j} \nabla W(\mathbf{r}_i - \mathbf{r}_j,h)
\end{equation}
Bohu¾el tato síla není symetrická, jak mù¾e být vidìt pøi interakci pouze dvou èástic. Gradient je nula uprostøed, proto èástice $i$ vyu¾ívá pouze tlak èástice $j$ pro výpoèet síly a naopak. Tlak v lokacích dvou rùzných èástic není shodný. Tlaková síla je symetrizována následovnì (mohou být i jiné tvary rovnice pro symetrizaci):
\begin{equation}
  \label{pressure_2}
  \mathbf{f}_i^{pressure} = \sum_{j} m_j \frac{p_i + p_j}{2\rho_j} \nabla W(\mathbf{r}_i - \mathbf{r}_j,h)
\end{equation}
Tlak $p_i$ se urèí pomocí modifikované rovnice ideálního plynu:
\begin{equation}
  \label{pressure_3}
  p_i = k (\rho - \rho_0)
\end{equation}
kde $\rho_0$ je klidová hustota.

\vspace*{1\baselineskip}

Síla viskozity $\mathbf{f}_i^{viscosity}$ je z rovnice \ref{basic} urèena:
\begin{equation}
  \label{viscosity_1}
  \mathbf{f}_i^{viscosity} = \mu \sum_{j} m_j \frac{\mathbf{v}_j}{\rho_j} \nabla^2 W(\mathbf{r}_i - \mathbf{r}_j,h)
\end{equation}
kde $\mu$ je viskozita kapaliny nebo plynu a $\mathbf{v}_i$ je rychlost èástice $i$. Tato síla je také nesymetrická. Je symetrizována následovnì:
\begin{equation}
  \label{viscosity_2}
  \mathbf{f}_i^{viscosity} = \mu \sum_{j} m_j \frac{\mathbf{v}_j - \mathbf{v}_i}{\rho_j} \nabla^2 W(\mathbf{r}_i - \mathbf{r}_j,h)
\end{equation}

Pro kapalinu by bylo vhodné poèítat povrchové napìtí. To my pro dým nepotøebujeme. Urèujeme vztlakovou sílu \cite{kelager06}, která je zpùsobena ¹íøením teplot. My modelujeme izotermální plyn proto ji vypoèítáme jako:
\begin{equation}
  \label{buoyancy}
  \mathbf{f}_i^{buoyancy} = b(\rho_i - \rho_0)\mathbf{g}
\end{equation}
kde $b > 0$ je koeficient vztlaku. Pokud bude hustota men¹í ne¾ klidová, èástice budou tlaèeny vzhùru.

Vyhlazovací funkce $W(\mathbf{r},h)$ velmi ovlivòují rychlost, stabilitu a pøesnost SPH metod. Pou¾íváme tøi rùzné kernely, pro dosa¾ení co nejlep¹ích výsledkù simulace, viz obrázek \ref{fig:kernels}. Jeden pro výpoèet hustoty, druhý pro tlakovou sílu a tøetí pro sílu viskozity. Tyto kernely jsou 

\begin{figure}[htb]
  \centering
  \includegraphics[width=13cm,keepaspectratio]{fig/kernels.png}
  \caption{Pou¾ité kernely. Zleva doprava pou¾ity pro výpoèet hustoty, tlakovou sílu a sílu viskozity. Tlusté èáry jsou kernely, tenké gradienty a ¹rafované Laplaciány.}
  \label{fig:kernels}
\end{figure}

Pro integraci èástic v èase pou¾íváme Eulerovo schéma. Zde se prvnì aktualizuje pozice rychlost $\mathbf{v}$:
\begin{equation}
  \label{velocity}
 \mathbf{v}_{t+\Delta t} = \mathbf{v}_{t} + \Delta t \mathbf{a}_t
\end{equation}
Poté se aktualizuje pozice $\mathbf{r}$:
\begin{equation}
  \label{pos}
 \mathbf{r}_{t+\Delta t} = \mathbf{r}_{t} + \Delta t \mathbf{v}_{t+\Delta t}
\end{equation}

Následnì se urèují kolize. Pøi kolizi s prostøedím je èástice odra¾ena smìrem od pøeká¾ky. 

\vspace*{1\baselineskip}

Pro správné zobrazování èástic je potøeba øazení. Pro implementaci jsme zvolili Bitonic sort \cite{bitonic_paper}, proto¾e je paralelní a datovì nezávislý a tudí¾ vhodný pro implementaci na GPU. Provádí $O(n\log(n^2))$ porovnání. Algoritmus øadí bitonické sekvence. Bitonická sekvence je sekvence, kde $x_0 \leq \dots \leq x_k \geq \dots \geq x_{n-1}$ pro nìjaké $k, 0 \leq k \leq n$, nebo cyklické posunutí této sekvence. 

Bitonic sort (viz obrázek \ref{fig:bitonic}) provádí $\log n$ iterací, kde výstupem ka¾dého prùchodu je pole tvoøené støídavì rostoucími a klesajícími posloupnostmi o velikosti $2^i$, kde $1 \leq i \leq \log n$ je èíslo iterace. Toho se dosáhne dal¹ími $i$ iteracemi v rámci $i$-té iterace. Ka¾dá tato iterace provádí porovnání mezi prvky s polovièní vzdáleností ne¾ ta pøedchozí (viz obrázek \ref{fig:bitonic}). Nakonec vznikne jedna rostoucí nebo klesající posloupnost.

Takto funguje bitonic sort pro posloupnosti délky mocniny 2. Triviální øe¹ení pro libovolné délky posloupnosti by bylo na konec uva¾ovat prvky maximální (resp. minimální) hodnoty. Proto¾e bitonic sort øadí prvky v sekvencích o støídajícíh se smìrech (rostoucí nebo klesající), tyto prvky by byly pøesouvány a musely by tedy fyzicky existovat. 

Nicménì v bitonic sortu není podstatné zda jsou sekvence øazeny jako rostoucí/klesající nebo naopak. Proto mù¾e být øazení upraveno tak, aby v ka¾dé iteraci $i$ byla na konci rostoucí (resp. klesající) sekvence a tím hodnoty nebudou nikdy pøesouvány a tudí¾ nemusí existovat.

\begin{figure}[htb]
  \centering
  \includegraphics[width=13cm,keepaspectratio]{fig/BitonicSort1.png}
  \caption{Sorting network Bitonic sortu. Pøevzato z Wikipedie.}
  \label{fig:bitonic}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Popis øe¹ení}

Tady struènì popi¹te, jakým zpùsobem jste prakticky projekt øe¹ili. Uveïte zejména pou¾ité
technologie a algoritmy. Zamìøte se hlavnì na zajímavé a dùle¾ité èásti implementace a také na
problémy, které jste øe¹ili. Není nutné popisovat ka¾dou tøídu.

Napø. uveïte, jak jste matematický popis z pøedchozí kapitoly implementovali prakticky.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Vyhodnocení}

Tady by mìlo být napsané jak to funguje. Proto¾e se jedná o poèítaèovou grafiku nebo
vidìní, tak by tady mìl byt screenshot, ze ktereho bude poznat jak to funguje.
K tomu by mìla být idealnì tabulka s vyhodnocením jak pøesnì/rychle to funguje.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Závìr}

Tady by mìlo být struènì napsané jak to funguje.


\bibliographystyle{alpha}
\begin{flushleft}
  \bibliography{project}
\end{flushleft}

%\appendix
%\newpage
%\section{}

\end{document}